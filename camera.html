<!DOCTYPE html>
<html>

<head>
    <title>Instascan</title>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <style>
        #container {
            margin: 0px auto;
            width: 500px;
            height: 375px;
            border: 10px #333 solid;
        }

        #videoElement {
            width: 500px;
            height: 375px;
            background-color: #666;
        }
    </style>
</head>

<body>

    <video autoplay="true" id="videoElement">
    </video>
    <form id="submitSend" method="GET">
        <button onclick="stop()">stop</button>
        <br>
        <p>Toaddress Wallet</p>
        <input id="show" type="text" class="form-control" size="80"></input>
        <p>Money</p>
        <input type="number" class="form-control" name="money" id="money" size="80"></input>
        <input type="hidden" class="form-control" name="fromAddress" id="showid" size="80"></input><br>
        <input type="hidden" class="form-control" name="fromAddress" id="fromAddress" size="80"></input>
        <!-- <p>e.g. 0x6c25FE295Ecee6F0D8D34fC28dca2de68538fA4a</p> -->
        <!-- <h5>privateKey</h5> -->
        <input type="hidden" class="form-control" name="privateKey" id="privateKey" size="80"></input>
        <br> <button type="submit" class="btn btn-primary">ENTER</button>


        <a id="result" ></a>
    </form>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script type="text/javascript">

        var url;
        var id;
        (() => {
            url = window.location.href
            id = url.split('/').slice(-1).toString() // ไอดี ของผู้ login
        })()

        function gotoCheckBalance() {
            // window.location.href = url.replace('send', 'balance')
            window.location.href = url.replace('send', 'balance', 'index')
        }
        function gotoindex() {
            // window.location.href = url.replace('send', 'balance')
            window.location.href = url.replace('send', 'index', 'send')
        }
        var video = document.querySelector("#videoElement");
        var button = document.querySelector("#videoElement");


        axios({
            method: 'GET',
            url: '/getWalletById', //ส่งไปค่านี้
            headers: {
                id: id  // รหัสนักศึกษา
            }
        }).then(result => { // ดึงค่ามาใส่ใน input ด้วย axios โดยตรง
            console.log("result_data", result)
            $('#fromAddress').val(result.data.address)
            $('#privateKey').val(result.data.privateKey)
            $('#showid').val(result.config.headers.id)
        })
        // ---------- Scan camera -------------------------------------------- //       
        let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
        scanner.addListener('scan', (content) => {
            console.log("Show Qrcode", content);

            document.querySelector('#submitSend').addEventListener('submit', e => {
                e.preventDefault()
                axios({ // ส่งค่าทั้งหมดไปๆ ยัง ฝั่ง nodejs
                    method: 'POST',
                    url: '/ShowTranferQrcode/' + id + '/confirm', // ส่งไปยังค่านี้
                    headers: {
                        id : id,
                        fromAddress: $('#fromAddress').val(),
                        toAddress: $('#toAddress').val(),
                        privateKey: $('#privateKey').val(),
                        money: $('#money').val(),
                        content: content, //toaddress wallet
                    }
                }).then(result => {
                    let link = "https://kovan.etherscan.io/tx/" + result.data.split('"')[1]
                    $("#result").attr("href", link)
                    $("#result").text(link)
                    // $("#result").val()
                }).catch(result => {
                    console.log("errr_send")
                })
            })

            axios({ // ส่งค่าทั้งหมดไปๆ ยัง ฝั่ง nodejs
                method: 'GET',
                url: '/camera/' + id + '/confirm', // ส่งไปยังค่านี้
                headers: {
                    // fromAddress: $('#fromAddress').val(),
                    // toAddress: $('#toAddress').val(),
                    // privateKey: $('#privateKey').val(),
                    // money: $('#money').val(),
                    content: content
                }

            },
                $('#show').val(content)
            ).then(result => {
                // value1: $('#text').val(content)
                // $('#text').val(content)
                console.log("Good Get Api ")
                // value1: $('#text').val(content)
                // let link = "https://kovan.etherscan.io/tx/" + result.data.split('"')[1]
                // $("#result").attr("href", link)
                // $("#result").text(link)
                // // $("#result").val()
            }).catch(result => {
                console.log("errr")
            })


        });
        Instascan.Camera.getCameras().then((cameras) => {
            if (cameras.length > 0) {
                scanner.start(cameras[0]);
            } else {
                console.error('No cameras found.');
            }
        }).catch(function (e) {
            console.error(e);
        });
        // ---------- Open camera -------------------------------------------- //
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    video.srcObject = stream;
                    // console.log("Something======", stream);
                })
                .catch((err0r) => {
                    console.log("Something went wrong!");
                });
        }
        // ---------- Stop camera -------------------------------------------- //
        function stop(e) { //stop
            var stream = video.srcObject;
            var tracks = stream.getTracks();

            for (var i = 0; i < tracks.length; i++) {
                var track = tracks[i];
                track.stop();
            }

            video.srcObject = null;
        }





    </script>
</body>

</html>